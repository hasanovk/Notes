<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd">
<en-note><div style="-evernote-webclip:true"><br/><div style="font-size: 16px; display: inline-block;"><div style="background-color:white;color:black;font-family:Arial,Lucida Grande,sans-serif;font-size:1em;"><div><div style="background-color:white;"><div dir="ltr" lang="en"><span></span>
<span></span><span></span><span></span><p>
</p><h1>Installing FreeBSD Root on ZFS (RAIDZ2) using GPT</h1>
<span></span><span></span><p></p><div style="border:1px solid rgb(187, 187, 187);color:black;background-color:rgb(238, 238, 238);font-size:80%;text-align:left;margin:0.5em 0px 0.5em 1em;padding:0.5em 0.75em 0.5em 0.5em;max-width:50%;display:inline-table;"><p style="font-weight:bold;padding:0px;margin:0px 0px 0.5em;letter-spacing:0.075em;">Contents</p><ol style="margin:0px;padding:0px 0px 0px 2em;"><li style="margin:0px;padding:0px;">
<a href="https://wiki.freebsd.org/RootOnZFS/GPTZFSBoot/RAIDZ2#Creating_a_bootable_ZFS_Filesystem" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">Creating a bootable ZFS Filesystem</a></li><li style="margin:0px;padding:0px;">
<a href="https://wiki.freebsd.org/RootOnZFS/GPTZFSBoot/RAIDZ2#A_Installing_FreeBSD_to_the_ZFS_filesystem" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;"> Installing FreeBSD to the ZFS filesystem</a></li><li style="margin:0px;padding:0px;">
<a href="https://wiki.freebsd.org/RootOnZFS/GPTZFSBoot/RAIDZ2#Finish_install" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">Finish install</a></li></ol></div> <span></span><span></span><p>
</p><h2>1. Creating a bootable ZFS Filesystem</h2>
<span></span><span></span><ol type="1"><li>Boot FreeBSD install DVD or USB Memstick <span></span><span></span></li><li style="margin-top:0.5em;">Choose Fixit option in sysinstall <span></span><span></span></li><li style="margin-top:0.5em;">Create GPT Disks <span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# gpart create -s gpt ad0
<span></span> Fixit# gpart create -s gpt ad1
<span></span> Fixit# gpart create -s gpt ad2</pre><span></span><span></span></li><li style="margin-top:0.5em;">Create the boot, swap and zfs partitions <span></span><span></span><p style="margin:0.25em 0px;">Create 3 partitions on drives ad0, ad1 and ad2.  The first partition contains the gptzfsboot loader which is able to recognize and load the loader from a <a href="https://wiki.freebsd.org/ZFS" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">ZFS</a> partition. The second partition is a 4 GB swap partition. The third partition is the partition containing the zpool (60GB). <span></span><span></span><span></span><span></span><span></span><span></span></p><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# gpart add -b 34 -s 128k -t freebsd-boot ad0
<span></span> Fixit# gpart add -s 4G -t freebsd-swap -l swap0 ad0
<span></span> Fixit# gpart add -s 60G -t freebsd-zfs -l disk0 ad0</pre><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# gpart add -b 34 -s 128k -t freebsd-boot ad1
<span></span> Fixit# gpart add -s 4G -t freebsd-swap -l swap1 ad1
<span></span> Fixit# gpart add -s 60G -t freebsd-zfs -l disk1 ad1</pre><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# gpart add -b 34 -s 128k -t freebsd-boot ad2
<span></span> Fixit# gpart add -s 4G -t freebsd-swap -l swap2 ad2
<span></span> Fixit# gpart add -s 60G -t freebsd-zfs -l disk2 ad2</pre><span></span><span></span><span></span><span></span><span></span><span></span><span></span><div style="border:1pt solid rgb(229, 229, 229);background-color:rgb(249, 249, 255);color:black;margin:10pt 30pt;background-repeat:no-repeat;background-position:8px 8px;min-height:64px;padding-left:64px;background-image:url(&amp;quot;../img/admon-note.png&amp;quot;);"><span></span><p style="margin:0.25em 0px;margin-top:8px;"><strong>Note:</strong> <span></span><span></span></p><ol type="1"><li><p style="margin:0.25em 0px;margin-top:8px;">While a <a href="https://wiki.freebsd.org/RootOnZFS#ZFS_Swap_Volume" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">ZFS Swap Volume</a> can be used instead of the freebsd-swap partition, crash dumps can't be created on the ZFS Swap Volume. <span></span></p></li><li>Sizes and offsets are specified in sectors (1 sector is typically 512 bytes) but can also be specified in MB/GB by adding an 'M' or 'G' suffix. </li></ol></div><span></span><span></span></li><li style="margin-top:0.5em;">Install the Protective MBR (pmbr) and gptzfsboot loader to all three drives <span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# gpart bootcode -b /mnt2/boot/pmbr -p /mnt2/boot/gptzfsboot -i 1 ad0
<span></span> Fixit# gpart bootcode -b /mnt2/boot/pmbr -p /mnt2/boot/gptzfsboot -i 1 ad1
<span></span> Fixit# gpart bootcode -b /mnt2/boot/pmbr -p /mnt2/boot/gptzfsboot -i 1 ad2</pre><span></span><span></span>This may fail with an "operation not permitted" error message, since the kernel likes to protect critical parts of the disk. If this happens for you, run: <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# sysctl kern.geom.debugflags=0x10</pre><span></span><span></span></li><li style="margin-top:0.5em;">Load ZFS kernel module <span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# kldload /mnt2/boot/kernel/opensolaris.ko
<span></span> Fixit# kldload /mnt2/boot/kernel/zfs.ko</pre><span></span><span></span></li><li style="margin-top:0.5em;">Create ZFS Pool zroot <span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# mkdir /boot/zfs
<span></span> Fixit# zpool create zroot raidz2 /dev/gpt/disk0 /dev/gpt/disk1 /dev/gpt/disk2
<span></span> Fixit# zpool set bootfs=zroot zroot</pre><span></span><span></span><span></span><span></span><span></span><span></span><div style="border:1pt solid rgb(229, 229, 229);background-color:rgb(249, 249, 255);color:black;margin:10pt 30pt;background-repeat:no-repeat;background-position:8px 8px;min-height:64px;padding-left:64px;background-image:url(&amp;quot;../img/admon-note.png&amp;quot;);"><span></span><p style="margin:0.25em 0px;margin-top:8px;"><strong>Note:</strong> <span></span><span></span></p><ul><li style="list-style-type:none;">zroot is the name of the ZFS Pool, it could be anything (i.e. tank, data, ...) </li></ul></div><span></span><span></span></li></ol><p>
</p><h2>2. <a href="https://wiki.freebsd.org/RootOnZFS/InstallingFreeBSD" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;"> Installing FreeBSD to the ZFS filesystem</a></h2>
<div dir="ltr" lang="en"><span></span>
<span></span><ol type="1"><li><p style="margin:0.25em 0px;">Create ZFS filesystem hierarchy<br/>
<br/>
 <span></span><span></span></p><p style="margin:0.25em 0px;">The <strong>fletcher4</strong> algorithm should be more robust than the <strong>fletcher2</strong> algorithm. <span></span><span></span><span></span></p><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs set checksum=fletcher4                                      zroot</pre><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs create -o compression=on    -o exec=on      -o setuid=off   zroot/tmp
<span></span> Fixit# chmod 1777 /zroot/tmp</pre><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs create                                                      zroot/usr
<span></span> Fixit# zfs create                                                      zroot/usr/home
<span></span> Fixit# cd /zroot ; ln -s /usr/home home</pre><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs create -o compression=lzjb                  -o setuid=off   zroot/usr/ports
<span></span> Fixit# zfs create -o compression=off   -o exec=off     -o setuid=off   zroot/usr/ports/distfiles
<span></span> Fixit# zfs create -o compression=off   -o exec=off     -o setuid=off   zroot/usr/ports/packages</pre><span></span><span></span><span></span><span></span><span></span><div style="border:1pt solid rgb(229, 229, 229);background-color:rgb(249, 249, 255);color:black;margin:10pt 30pt;background-repeat:no-repeat;background-position:8px 8px;min-height:64px;padding-left:64px;background-image:url(&amp;quot;../img/admon-note.png&amp;quot;);"><span></span><p style="margin:0.25em 0px;margin-top:8px;"><strong>Note:</strong> <span></span><span></span></p><p style="margin:0.25em 0px;margin-top:8px;">If you use nullfs or nfs to mount /usr/ports to different locations/servers, you will also need to nullfs/nfs mount /usr/ports/distfiles and/or /usr/ports/packages. </p></div><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs create -o compression=lzjb  -o exec=off     -o setuid=off   zroot/usr/src</pre><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs create                                                      zroot/var
<span></span> Fixit# zfs create -o compression=lzjb  -o exec=off     -o setuid=off   zroot/var/crash
<span></span> Fixit# zfs create                      -o exec=off     -o setuid=off   zroot/var/db
<span></span> Fixit# zfs create -o compression=lzjb  -o exec=on      -o setuid=off   zroot/var/db/pkg
<span></span> Fixit# zfs create                      -o exec=off     -o setuid=off   zroot/var/empty
<span></span> Fixit# zfs create -o compression=lzjb  -o exec=off     -o setuid=off   zroot/var/log
<span></span> Fixit# zfs create -o compression=gzip  -o exec=off     -o setuid=off   zroot/var/mail
<span></span> Fixit# zfs create                      -o exec=off     -o setuid=off   zroot/var/run
<span></span> Fixit# zfs create -o compression=lzjb  -o exec=on      -o setuid=off   zroot/var/tmp
<span></span> Fixit# chmod 1777 /zroot/var/tmp</pre><span></span><span></span><span></span><span></span><span></span><span></span><span></span><div style="border:1pt solid rgb(229, 229, 229);background-color:rgb(249, 249, 255);color:black;margin:10pt 30pt;background-repeat:no-repeat;background-position:8px 8px;min-height:64px;padding-left:64px;background-image:url(&amp;quot;../img/admon-note.png&amp;quot;);"><span></span><p style="margin:0.25em 0px;margin-top:8px;"><strong>Note:</strong> <span></span><span></span></p><ol type="1"><li>Compression may be set to on, off, lzjb, gzip, gzip-N (where N is an integer from 1 (fastest) to 9 (best compression ratio.  gzip is equivalent to gzip-6). <span></span></li><li><p style="margin:0.25em 0px;margin-top:8px;">Compression will cause some latency when accessing files on the <a href="https://wiki.freebsd.org/ZFS" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">ZFS</a> filesystems.  Use compression on <a href="https://wiki.freebsd.org/ZFS" style="color:rgb(0, 68, 179);border:0px none;text-decoration:none;">ZFS</a> filesystems which will not be accessed that often. </p></li></ol></div><span></span><span></span></li><li style="margin-top:0.5em;">Install FreeBSD to zroot <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# cd /dist/8.0-*
<span></span> Fixit# export DESTDIR=/zroot
<span></span> Fixit# for dir in base catpages dict doc games info lib32 manpages ports; \
<span></span>          do (cd $dir ; ./install.sh) ; done
<span></span> Fixit# cd src ; ./install.sh all
<span></span> Fixit# cd ../kernels ; ./install.sh generic
<span></span> Fixit# cd /zroot/boot ; cp -Rlp GENERIC/* /zroot/boot/kernel/</pre><span></span><span></span></li><li style="margin-top:0.5em;">Make /var/empty readonly <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs set readonly=on zroot/var/empty</pre><span></span><span></span></li><li style="margin-top:0.5em;">chroot into /zroot <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# chroot /zroot</pre><span></span><span></span></li><li style="margin-top:0.5em;">Create /etc/rc.conf <span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# echo 'zfs_enable="YES"' &gt; /etc/rc.conf
<span></span> Fixit# echo 'hostname="beastie.mydomain.local"' &gt;&gt; /etc/rc.conf
<span></span> Fixit# echo 'ifconfig_re0="DHCP"' &gt;&gt; /etc/rc.conf</pre><span></span><span></span><span></span><span></span><span></span><div style="border:1pt solid rgb(229, 229, 229);background-color:rgb(249, 249, 255);color:black;margin:10pt 30pt;background-repeat:no-repeat;background-position:8px 8px;min-height:64px;padding-left:64px;background-image:url(&amp;quot;../img/admon-note.png&amp;quot;);"><span></span><p style="margin:0.25em 0px;margin-top:8px;"><strong>Note:</strong> <span></span><span></span></p><ul><li style="list-style-type:none;">Replace re0 with the name of the Network interface for the new system </li></ul></div><span></span><span></span></li><li style="margin-top:0.5em;">Create /boot/loader.conf <span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# echo 'zfs_load="YES"' &gt; /boot/loader.conf
<span></span> Fixit# echo 'vfs.root.mountfrom="zfs:zroot"' &gt;&gt; /boot/loader.conf</pre><span></span><span></span><span></span></li><li style="margin-top:0.5em;">Change root's password <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# passwd</pre><span></span><span></span></li><li style="margin-top:0.5em;">Set the local time zone <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# tzsetup</pre><span></span><span></span></li><li style="margin-top:0.5em;">Create /etc/mail/aliases.db <span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# cd /etc/mail
<span></span> Fixit# make aliases</pre><span></span><span></span></li><li style="margin-top:0.5em;">Exit from the /zroot <span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# umount /dev
<span></span> Fixit# exit</pre><span></span><span></span></li><li style="margin-top:0.5em;">Install zpool.cache to the ZFS filesystem <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# cp /boot/zfs/zpool.cache /zroot/boot/zfs/zpool.cache</pre><span></span></li></ol><span></span></div> <span></span><span></span><p>
</p><h2>3. Finish install</h2>
<span></span><span></span><ol type="1"><li>Create /etc/fstab <span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# cat &lt;&lt; EOF &gt; /zroot/etc/fstab
<span></span> # Device                       Mountpoint              FStype  Options         Dump    Pass#
<span></span> /dev/gpt/swap0                 none                    swap    sw              0       0
<span></span> /dev/gpt/swap1                 none                    swap    sw              0       0
<span></span> /dev/gpt/swap2                 none                    swap    sw              0       0
<span></span> EOF</pre><span></span><span></span></li><li style="margin-top:0.5em;">export LD_LIBRARY_PATH  <span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# export LD_LIBRARY_PATH=/mnt2/lib </pre><span></span><span></span></li><li style="margin-top:0.5em;">Unmount all zfs filesystems <span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs unmount -a</pre><span></span><span></span></li><li style="margin-top:0.5em;">Change mount points for zroot pool  <span></span><span></span><span></span><span></span><span></span><span></span><span></span><pre style="border:1pt solid rgb(174, 189, 204);background-color:rgb(243, 245, 247);padding:5pt;font-family:courier,monospace;white-space:pre-wrap;overflow-wrap:break-word;"><span></span> Fixit# zfs set mountpoint=legacy zroot
<span></span> Fixit# zfs set mountpoint=/tmp zroot/tmp
<span></span> Fixit# zfs set mountpoint=/usr zroot/usr
<span></span> Fixit# zfs set mountpoint=/var zroot/var</pre><span></span><span></span></li><li style="margin-top:0.5em;">Exit Fixit mode, and then sysinstall.  Remove the FreeBSD install DVD/Memstick and the system will boot using the ZFS root. <span></span></li></ol><span></span></div></div></div></div></div><br/></div></en-note>