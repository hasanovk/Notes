<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note><div><span style="color: rgb(146, 146, 146);"># Written by KFH: </span><a href="mailto:karshi.hasanov@utoronto.ca" style="color: rgb(255, 64, 255);">karshi.hasanov@utoronto.ca</a></div><div><span style="color: rgb(146, 146, 146);"># Date: October 5, 2015</span></div><div><span style="color: rgb(146, 146, 146);"># Description: Installing and setting up the DNS Server on FreeBSD 11.1</span></div><div><span style="color: rgb(146, 146, 146);"># Last Modified: March 18, 2018</span></div><div><span style="color: rgb(146, 146, 146);"># Updates: 1. The “/etc/hosts” and “/etc/resolv.conf” files modified.</span></div><div><span style="color: rgb(146, 146, 146);">#                     You only need the localhost (i.e. “127.0.0.1”) to be present.</span></div><div><span style="color: rgb(146, 146, 146);">#                 2. The second zone , 172.16.0.0/24, was added  and tested.       </span></div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;">Installation</span></div><div><br /></div><div><span style="color: rgb(0, 84, 147); font-weight: bold;">Note:</span><span style="color: rgb(0, 84, 147);"> Since FreeBSD 10.x no more the “base” BIND in the FreeBSD</span></div><div><span style="color: rgb(0, 84, 147);">So, you won’t find "/etc/namedb” and "/usr/sbin/named”</span></div><div><span style="color: rgb(0, 84, 147);">and you don’t need to make a link to those files.</span></div><div><br /></div><div>=&gt; <span style="font-weight: bold;">cd</span> <span style="color: rgb(148, 17, 0);">/usr/ports/dns/bind99 </span></div><div>=   <span style="font-weight: bold;">sudo make install clean</span></div><div><br /></div><div>Add the line <span style="font-weight: bold;">named_enable="YES"</span> to<span style="font-style: italic;"> "/etc/rc.conf"</span></div><div>Make sure the following files are setup "<span style="color: rgb(148, 33, 147);">/etc/hosts</span>"  and "<span style="color: rgb(255, 64, 255);">/etc/resolv.conf</span>"</div><div><span style="color: rgb(148, 33, 147);">⁃-------------------- /etc/hosts -------------------</span></div><div><span style="color: rgb(148, 33, 147);">127.0.0.1    localhost</span></div><div><br /></div><div><span style="color: rgb(255, 64, 255);">--------------------/etc/resolv.conf---------------</span></div><div><span style="color: rgb(255, 64, 255);">search </span><a href="http://karshi.ca" style="color: rgb(255, 64, 255);">karshi.ca</a></div><div><span style="color: rgb(255, 64, 255);">nameserver 127.0.0.1</span></div><div><br /></div><div><span style="font-style: italic; color: rgb(0, 84, 147);"># You are allowed 3 nameservers in the "resolve.conf" file.</span></div><div><span style="font-style: italic; color: rgb(0, 84, 147);"># </span><span style="font-style: italic; color: rgb(0, 84, 147); font-weight: bold;">The order is important:</span><span style="font-style: italic; color: rgb(0, 84, 147);"> The first DNS gets call first and</span></div><div><span style="font-style: italic; color: rgb(0, 84, 147);"># if it can not resolve the name, second one gets call and it</span></div><div><span style="font-style: italic; color: rgb(0, 84, 147);"># does not then the third one.</span></div><div><hr /></div><div><span style="font-size: 24px; font-weight: bold;">Cache-Only DNS Server</span></div><div><span style="color: rgb(146, 146, 146);"># In the file "/usr/local/etc/namedb/</span><span style="color: rgb(146, 146, 146); font-weight: bold;">named.conf</span><span style="color: rgb(146, 146, 146);">" file:</span></div><div><span style="color: rgb(146, 146, 146);"># If you want the DNS Server to listen and serve outside, comment this:</span></div><div> <span style="color: rgb(146, 144, 0);">// </span><span style="color: rgb(146, 144, 0); font-weight: bold;"> listen-on</span><span style="color: rgb(146, 144, 0);">      { 127.0.0.1; };</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># If the DNS can't resolve the request, it will appeal an upper level DNS Server</span></div><div>  <span style="font-weight: bold;"><font color="#008f00"> forwarders</font></span> {</div><div>                        <font color="#0433ff">192.168.100.1; </font>    <font color="#929292">// Bell Modem</font></div><div>                        }</div><div><hr /></div><div><span style="font-size: 24px; font-weight: bold;">Master DNS Server</span></div><div><br /></div><div><span style="font-size: 18px; font-weight: bold;">Part 1: The RNDC Key and Configuration File</span></div><div><span style="font-weight: bold; font-size: 14px;">--------------------------------------------------------------------</span></div><div><span style="font-size: 14px; font-weight: bold;">#</span><span style="font-size: 14px;"> First you need to the create rndc key file</span></div><div><span style="font-size: 14px;">=&gt;</span><span style="font-size: 14px; font-weight: bold;"> sudo</span><span style="font-size: 14px;"> </span><span style="font-size: 14px; color: rgb(0, 143, 0);">rndc-confgen</span></div><div><span style="font-size: 14px;">1. Copy the output to the file </span><span style="font-size: 14px; color: rgb(148, 17, 0);">/usr/local/etc/namedb/</span><span style="font-size: 14px; font-weight: bold;">rndc.conf</span></div><div>2. Copy the “key” part to the file <span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/</span><span style="font-weight: bold;">rndc.key</span></div><div><span style="color: rgb(121, 121, 121);">( replace if the existing key )</span></div><div><span style="color: rgb(121, 121, 121);"># An example of the key part:</span></div><div><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">key "rndc-key" {</span></div><div><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">algorithm hmac-md5;</span></div><div><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">secret "iL3/n6BPIFhg9MnV/l3TBA==";</span></div><div><span style="color: rgb(121, 121, 121);">    </span><span style="color: rgb(121, 121, 121);">};</span></div><div>3. Insert the line<span style="color: rgb(148, 55, 255);"> include</span> <span style="color: rgb(148, 17, 0);">“/usr/local/etc/named/rndc.key” </span> before the  “<span style="color: rgb(146, 144, 0);">options</span>”</div><div>   ( don’t forget “;” at the end ! )   </div><div> in the <span style="font-weight: bold;">/usr/local/etc/namedb/</span><span style="color: rgb(0, 84, 147); font-weight: bold;">named.conf</span><span style="color: rgb(0, 84, 147);"> </span>file.</div><div><br /></div><div><font style="font-size: 18px;"><span style="font-weight: bold;">Part 2</span> :<span style="font-weight: bold;"> Editing the</span></font> <span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/</span><span style="color: rgb(0, 84, 147);">named.conf</span><font style="font-size: 18px;"><span style="font-weight: bold;"> </span><span style="font-weight: bold;">file</span></font></div><div>--------------------------------------------------------------------</div><div><span style="color: rgb(145, 145, 145);">// KFH: Forward Zone for 192.168.100.0/24</span></div><div><span style="font-weight: bold;">zone </span>“<span style="color: rgb(4, 51, 255);">karshi.ca</span>" {</div><div>       <span style="font-weight: bold;"> type </span><span style="color: rgb(0, 144, 81);">master</span> ;</div><div>       <span style="font-style: italic; font-weight: bold;"> file</span> "<span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(4, 51, 255);">forward_karshi.ca</span> ";</div><div>};</div><div><br /></div><div><span style="color: rgb(145, 145, 145);">// KFH: Reverse Zone for 192.168.100.0/24</span></div><div><span style="color: rgb(145, 145, 145);">// The first three octets are need to be reversed.</span>           </div><div><span style="font-weight: bold;">zone</span> "<span style="color: rgb(255, 38, 0);">100.168.192.in-addr.arpa</span>" {</div><div>        <span style="font-weight: bold;">type</span><span style="color: rgb(0, 143, 0); font-weight: bold;"> </span><span style="color: rgb(0, 143, 0);">master </span>;</div><div>       <span style="font-style: italic; font-weight: bold;"> file</span> "<span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(255, 38, 0);">reverse_karshi.ca</span>";</div><div>};</div><div><br /></div><div><span style="color: rgb(145, 145, 145);">// KFH: Forward Zone for 172.16.0.0/24</span></div><div><span style="font-weight: bold;">zone </span>“<span style="color: rgb(0, 84, 147);">karshi.local</span>" {</div><div>       <span style="font-weight: bold;"> type </span><span style="color: rgb(0, 144, 81);">master</span> ;</div><div>       <span style="font-style: italic; font-weight: bold;"> file</span> "<span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(0, 84, 147);">forward_karshi.local </span>";</div><div>};</div><div><br /></div><div><span style="color: rgb(145, 145, 145);">// KFH: Reverse Zone for 172.16.0.0/24</span></div><div><span style="color: rgb(145, 145, 145);">// The first three octets are need to be reversed.</span>           </div><div><span style="font-weight: bold;">zone</span> "<span style="color: rgb(255, 64, 255);">0.16.172.in-addr.arpa</span>" {</div><div>        <span style="font-weight: bold;">type</span><span style="color: rgb(0, 143, 0); font-weight: bold;"> </span><span style="color: rgb(0, 143, 0);">master </span>;</div><div>       <span style="font-style: italic; font-weight: bold;"> file</span> "<span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(255, 64, 255);">reverse_karshi.local</span>";</div><div>};</div><div><br /></div><div><br /></div><div><span style="font-weight: bold;"><font style="font-size: 18px;">Part 3: Creating the Forward and Reverse Files</font></span></div><div> <span style="color: rgb(4, 51, 255);">forward_karshi.ca </span></div><div>----------------------------------------------------------------------------------</div><div><span style="font-weight: bold;">$TTL</span> 3600      <span style="font-weight: bold;"> ; </span><span style="color: rgb(121, 121, 121);">1 hour default TTL</span></div><div><span style="color: rgb(4, 51, 255);">karshi.ca.   </span>  <span style="font-weight: bold;">   IN </span>    <span style="font-weight: bold;"> SOA </span>     kfh<span style="color: rgb(4, 51, 255);">.karshi.ca. </span><span style="color: rgb(255, 38, 0);">admin.karshi.ca </span><span style="font-weight: bold;">(</span></div><div>                               <span style="font-weight: bold;"> 20151005     ;</span>     <span style="color: rgb(146, 146, 146);">Serial number: Usually year/month/day</span></div><div>                                <span style="font-weight: bold;">10800           ;</span><span style="font-weight: bold;">    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Refresh: If there any slave DNS, it must wait this amount of seconds for an update</span></div><div>                               <span style="font-weight: bold;"> 3600             ;</span><span style="color: rgb(146, 146, 146); font-weight: bold;">    </span><span style="font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Retry: If for some reason a slave DNS get disconnected, it must try after these seconds</span></div><div>                               <span style="font-weight: bold;"> 604800         ;</span><span style="font-weight: bold;">    </span> <span style="color: rgb(146, 146, 146);">Expire: If a slave DNS won't contact after this amount of seconds, the DNS Server </span></div><div>                                                    <span style="font-weight: bold;"> ;</span>     <span style="color: rgb(146, 146, 146);">will stop answering DNS queries</span></div><div>                               <span style="font-weight: bold;"> 86400           ;    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Negative Response TTL: When the DNS can't resolve a name, it will keep the answer </span></div><div>                                                    <span style="font-weight: bold;"> ;</span><span style="font-weight: bold;">    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">in a cache for so long time.</span></div><div>                              <span style="font-weight: bold;">  )</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);">; DNS Servers</span></div><div><span style="color: rgb(4, 51, 255);">karshi.ca. </span>             <span style="font-weight: bold;">  IN </span>   <span style="font-weight: bold;">  </span><span style="color: rgb(122, 129, 255); font-weight: bold;">NS</span><span style="font-weight: bold;"> </span>     <span style="color: rgb(4, 51, 255);">freebsd.karshi.ca.</span></div><div><br /></div><div><br /></div><div><span style="color: rgb(145, 145, 145);">; Machine Names</span></div><div><span style="font-weight: bold;">localhost</span><span style="font-weight: bold;"> </span>    <span style="font-weight: bold;">   </span><span style="font-weight: bold;">IN</span>     <span style="color: rgb(0, 145, 147);"> A</span>      <span style="color: rgb(0, 145, 147);"> 127.0.0.1</span></div><div><span style="font-weight: bold;">imac  </span>           <span style="font-weight: bold;">  IN</span>      <span style="color: rgb(0, 145, 147);">A        192.168.100.100</span></div><div><span style="font-weight: bold;">freebsd</span>          <span style="font-weight: bold;"> </span><span style="font-weight: bold;">IN</span>      <span style="color: rgb(0, 145, 147);">A       192.168.100.150</span></div><div><span style="font-weight: bold;">linux </span>              <span style="font-weight: bold;"> </span><span style="font-weight: bold;">IN  </span>    <span style="color: rgb(0, 145, 147);">A       192.168.100.160</span></div><div><span style="font-weight: bold;">windows</span>        <span style="font-weight: bold;"> IN</span>      <span style="color: rgb(0, 145, 147);">A       192.168.100.170</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);">; Aliases</span></div><div><span style="font-weight: bold;">ns1 </span>              <span style="font-weight: bold;">  IN </span>     <span style="color: rgb(148, 55, 255);">CNAME</span>  <span style="color: rgb(148, 55, 255);"> freebsd.karshi.ca.</span></div><div><span style="font-weight: bold;">www</span>            <span style="font-weight: bold;">  IN</span>       <span style="color: rgb(148, 55, 255);">CNAME  @  </span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);">; Mail Exchange Server</span></div><div><span style="color: rgb(146, 146, 146);">;                    IN MX 10   mail.karshi.ca.</span></div><div><br /></div><div><br /></div><div> </div><div><span style="color: rgb(255, 38, 0);">reverse_karshi.ca</span><span style="color: rgb(4, 51, 255); font-weight: bold;"> </span></div><div>----------------------------------------------------------------------------------------------------</div><div><span style="font-weight: bold;">$TTL</span> 3600      <span style="font-weight: bold;"> ; </span><span style="color: rgb(121, 121, 121);">1 hour default TTL</span></div><div><span style="color: rgb(255, 38, 0);">100.168.192.in-addr.arpa.   </span><span style="color: rgb(4, 51, 255);"> </span>  <span style="font-weight: bold;">   IN </span>    <span style="font-weight: bold;"> SOA </span>     <span style="color: rgb(4, 51, 255);">freebsd.karshi.ca. </span><span style="color: rgb(255, 38, 0);">admin.karshi.ca </span><span style="font-weight: bold;">(</span></div><div>                               <span style="font-weight: bold;"> 20151005     ;</span>     <span style="color: rgb(146, 146, 146);">Serial number: Usually year/month/day</span></div><div>                                <span style="font-weight: bold;">10800           ;</span><span style="font-weight: bold;">    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Refresh: If there any slave DNS, it must wait this amount of seconds for an update</span></div><div>                               <span style="font-weight: bold;"> 3600             ;</span><span style="color: rgb(146, 146, 146); font-weight: bold;">    </span><span style="font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Retry: If for some reason a slave DNS get disconnected, it must try after these seconds</span></div><div>                               <span style="font-weight: bold;"> 604800         ;</span><span style="font-weight: bold;">    </span> <span style="color: rgb(146, 146, 146);">Expire: If a slave DNS won't contact after this amount of seconds, the DNS Server </span></div><div>                                                    <span style="font-weight: bold;"> ;</span>     <span style="color: rgb(146, 146, 146);">will stop answering DNS queries</span></div><div>                               <span style="font-weight: bold;"> 86400           ;    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">Negative Response TTL: When the DNS can't resolve a name, it will keep the answer </span></div><div>                                                    <span style="font-weight: bold;"> ;</span><span style="font-weight: bold;">    </span><span style="color: rgb(146, 146, 146); font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);">in a cache for so long time.</span></div><div>                              <span style="font-weight: bold;">  )</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);">; DNS Servers</span></div><div><span style="color: rgb(255, 38, 0);">100.168.192.in-addr.arpa. </span>             <span style="font-weight: bold;">  IN </span>   <span style="font-weight: bold;">  </span><span style="color: rgb(122, 129, 255); font-weight: bold;">NS</span><span style="font-weight: bold;"> </span>     <span style="color: rgb(4, 51, 255);">freebsd.karshi.ca.</span></div><div><br /></div><div><br /></div><div><span style="color: rgb(145, 145, 145);">; Machine Names</span></div><div><span style="color: rgb(145, 145, 145);">; Don’t forget “.” after the hostname !</span></div><div><span style="font-weight: bold;">100 </span>           <span style="font-weight: bold;">  IN</span>      <span style="color: rgb(148, 17, 0);">PTR        imac.karshi.ca.</span></div><div><span style="font-weight: bold;">150</span>             <span style="font-weight: bold;"> </span><span style="font-weight: bold;">IN</span>      <span style="color: rgb(148, 17, 0);">PTR       freebsd.karshi.ca.</span></div><div><span style="font-weight: bold;">160 </span>             <span style="font-weight: bold;">IN  </span>  <span style="color: rgb(148, 17, 0);">  PTR      linux.karshi.ca.</span></div><div><span style="font-weight: bold;">170</span>        <span style="font-weight: bold;">      IN</span>      <span style="color: rgb(148, 17, 0);">PTR      windows.karshi.ca.</span></div><div><br /></div><div>----------------------------------------------------------------------------------------------------------------------</div><div>Note: For  <span style="color: rgb(0, 84, 147);">forward_karshi.local </span>and <span style="color: rgb(255, 64, 255);">reverse_karshi.local </span> files do replace"</div><div>“<span style="color: rgb(4, 51, 255);">karshi.ca</span>” ==&gt;  “<span style="color: rgb(0, 84, 147);">karshi.local</span>”  </div><div>“<span style="color: rgb(255, 47, 146);">100.168.192</span>” ==&gt;  “<span style="color: rgb(255, 64, 255);">0.16.172</span>"</div><div>----------------------------------------------------------------------------------------------------------------------</div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;">Troubleshooting</span></div><div><hr /></div><div>=&gt; <span style="font-weight: bold;">dig</span><span style="color: rgb(148, 17, 0);"> @localhost</span>  <a href="http://www.google.com">www.google.com</a></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">named</span> <span style="color: rgb(0, 144, 81);">-g</span></div><div># To check the zones</div><div># =&gt; sudo named-checkzone &lt;zone name&gt;  &lt; file where the zone is defines&gt;</div><div>=&gt; sudo <span style="font-weight: bold;">named-checkzone</span> <span style="color: rgb(4, 51, 255);">karshi.ca</span> <span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(4, 51, 255);">forward_karshi.ca</span></div><div>=&gt; sudo <span style="font-weight: bold;">named-checkzone</span> <span style="color: rgb(4, 51, 255);">karshi.ca</span> <span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master</span><span style="color: rgb(255, 47, 146);">/reverse_karshi.ca</span></div><div><br /></div><div>=&gt; sudo <span style="font-weight: bold;">named-checkzone</span><span style="color: rgb(0, 84, 147);"> karshi.ca </span><span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master/</span><span style="color: rgb(0, 84, 147);">forward_karshi.local</span></div><div>=&gt; sudo <span style="font-weight: bold;">named-checkzone</span> <span style="color: rgb(0, 84, 147);">karshi.ca</span> <span style="color: rgb(148, 17, 0);">/usr/local/etc/namedb/master</span><span style="color: rgb(255, 64, 255);">/reverse_karshi.local</span></div><div><br /></div></en-note>