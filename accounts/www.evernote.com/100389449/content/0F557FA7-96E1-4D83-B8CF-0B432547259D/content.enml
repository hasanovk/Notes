<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note><div>Installing Ubuntu under FreeBSD</div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Packages Require: </span><span style="font-weight: bold; color: rgb(145, 145, 145);">vm-bhyve</span><span style="color: rgb(146, 146, 146);"> and</span><span style="color: rgb(145, 145, 145);"> </span><span style="color: rgb(145, 145, 145); font-weight: bold;">grub2-bhyve</span></div><div><span style="color: rgb(146, 146, 146);"># =&gt; sudo pkg install vm-bhyve grub2-bhyve</span></div><div><span style="color: rgb(146, 146, 146);"># or</span></div><div>=&gt;<span style="font-weight: bold;"> cd</span> <span style="color: rgb(148, 17, 0);">/usr/ports/sysutils/vm-bhyve/</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span> <span style="font-weight: bold;">make install clean</span></div><div>=&gt; <span style="font-weight: bold;">cd</span> /usr/ports/sysutils/grub2-bhyve/</div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">make install clean</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Load kernel modules</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span><span style="font-weight: bold;"> kldload</span><span style="color: rgb(148, 55, 255);"> if_bridge if_tap nmdm vmm</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Make loading of kernel modules persistent</span></div><div><span style="color: rgb(146, 146, 146);"># Edit the </span><span style="color: rgb(121, 121, 121);">/boot/loader.conf</span><span style="color: rgb(146, 146, 146);"> and add the following line:</span></div><div>   <span style="color: rgb(146, 144, 0);"> if_bridge_load</span>=“<span style="color: rgb(0, 144, 81);">YES</span>"</div><div>   <span style="color: rgb(146, 144, 0);"> if_tap_load</span>=“<span style="color: rgb(0, 144, 81);">YES</span>"</div><div>    <span style="color: rgb(146, 144, 0);">nmdm_load</span>=“<span style="color: rgb(0, 144, 81);">YES</span>"</div><div>   <span style="color: rgb(146, 144, 0);"> vmm_load</span>=“<span style="color: rgb(0, 144, 81);">YES</span>"</div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Edit the /etc/rc.conf and add the lines</span></div><div>    <span style="color: rgb(146, 144, 0);">vm_enable</span>=“<span style="color: rgb(0, 143, 0);">YES</span>"</div><div>    <span style="color: rgb(146, 144, 0);">vm_enable</span>=“<span style="color: rgb(0, 143, 0);">YES</span>"</div><div>    <span style="color: rgb(146, 144, 0);">vm_list</span>=“"</div><div>     <span style="color: rgb(146, 144, 0);">vm_delay</span>=“<span style="color: rgb(0, 143, 0);">5</span>"</div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Note. The above step can be done using the “sysrc” command:</span></div><div><span style="color: rgb(146, 146, 146);">#  sysrc vm_enable=“YES”</span> </div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Create a zfs file system for VMs</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span><span style="font-weight: bold;"> zfs create -o mountpoint</span>=<span style="color: rgb(148, 17, 0);">/vms</span>  <span style="color: rgb(255, 47, 146);">zroot</span>/<span style="color: rgb(148, 17, 0);">vms</span></div><div><span style="color: rgb(146, 146, 146);"># Note: My zpool name is “zroot”. Replace it with yours</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Initiate the VM</span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span><span style="font-weight: bold;"> vm</span><span style="color: rgb(0, 145, 147);"> init</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Copy VM Template examples to the /vms/.templates/</span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span><span style="color: rgb(148, 17, 0);"> /usr/local/share/examples/vm-bhyve/*</span> <span style="color: rgb(146, 144, 0);">/vms/.templates/</span></div><div><span style="color: rgb(146, 146, 146);"># You will find different template examples for different OS’s here</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Create bridge device, replace em1 with your network controller</span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">vm</span> <span style="color: rgb(4, 51, 255);">switch</span> <span style="font-weight: bold;">create</span><span style="color: rgb(0, 144, 81);"> public</span></div><div>=&gt; <span style="font-weight: bold;">vm</span> <span style="color: rgb(4, 51, 255);">switch</span><span style="font-weight: bold;"> add</span> <span style="color: rgb(0, 143, 0);">public</span> <span style="font-weight: bold;">em1</span></div><div><span style="color: rgb(146, 146, 146);"># I have the “em0” facing to the “internet” and “em1” to local.</span></div><div><span style="color: rgb(146, 146, 146);"># My router setup as a router, so there is the forwarding going on</span></div><div><span style="color: rgb(146, 146, 146);"># between the “em0” and “em1” interfaces.</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Grab Ubuntu 16.04 ISO</span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">vm iso</span>  <a href="http://mirror.csclub.uwaterloo.ca/ubuntu-releases/16.04.4/ubuntu-16.04.4-server-amd64.iso">http://mirror.csclub.uwaterloo.ca/ubuntu-releases/16.04.4/ubuntu-16.04.4-server-amd64.iso</a></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Note: The above command will save the ISO image under “/vms/.iso”</span></div><div><span style="color: rgb(146, 146, 146);"># so next time you want to create another Ubuntu VM you don’t need to</span></div><div><span style="color: rgb(146, 146, 146);"># download again.</span></div><div><br /></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Create VM and start installation from the ISO. After installation is done</span></div><div><span style="color: rgb(146, 146, 146);"># and OpenSSH is configured to start on boot, shut down the machine to gain back</span></div><div><span style="color: rgb(146, 146, 146);"># control over your FreeBSD session</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);">#  “-t ubuntu” means use the Ubuntu template defined in "/vms/.templates/“ folder</span></div><div><span style="color: rgb(146, 146, 146);"># “-s 100G” create 100G size for the our new VM and we want to call it “ubuntu-gts" </span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">vm create</span> <span style="color: rgb(148, 17, 0);">-t ubuntu</span> -<span style="color: rgb(0, 84, 147);">s 100G</span><span style="color: rgb(4, 51, 255);"> ubuntu-gts</span></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Installing the new VM using our downloaded ISO image</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span> <span style="font-weight: bold;">vm install</span><span style="color: rgb(4, 51, 255);"> ubuntu-gts</span> <span style="font-weight: bold;">ubuntu-16.04.4-server-amd64.iso</span></div><div><br style="color: rgb(146, 146, 146);" /></div><div><span style="color: rgb(146, 146, 146);"># To start our newly created VM at boot , we need to add to the “vm_list”</span></div><div><span style="color: rgb(146, 146, 146);"># defined in “/etc/rc.conf"</span></div><div><span style="color: rgb(146, 146, 146);">    </span><span style="color: rgb(146, 144, 0);">vm_list</span><span style="color: rgb(146, 146, 146);">=“</span><span style="color: rgb(0, 143, 0);">ubuntu-gts</span><span style="color: rgb(146, 146, 146);">"</span></div><div><span style="color: rgb(146, 146, 146);"># You can add mutiple VM in the list separted by a space</span></div><div><br /></div><div><br /></div><div><span style="color: rgb(146, 146, 146);"># Optional: If you want to do more configuration or change some of the</span></div><div><span style="color: rgb(146, 146, 146);"># settings, it time to do so.</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span><span style="font-weight: bold;"> vm configure</span><span style="color: rgb(4, 51, 255);"> ubuntu-gts</span></div><div><br style="color: rgb(146, 146, 146);" /></div><div><span style="color: rgb(146, 146, 146);"># Start VM</span></div><div>=&gt; <span style="color: rgb(255, 47, 146);">sudo</span> <span style="font-weight: bold;">vm start</span><span style="color: rgb(4, 51, 255);"> ubuntu-gts</span></div><div><br style="color: rgb(146, 146, 146);" /></div><div><span style="color: rgb(146, 146, 146);"># Open console on VM</span></div><div>=&gt;<span style="color: rgb(255, 47, 146);"> sudo</span> <span style="font-weight: bold;">vm console</span><span style="color: rgb(4, 51, 255);"> ubuntu-gts</span></div><div><br /></div><div><br /></div><div><br /></div></en-note>