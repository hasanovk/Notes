<!DOCTYPE en-note SYSTEM "http://xml.evernote.com/pub/enml2.dtd"><en-note><div><span style="color: rgb(145, 145, 145);"># Written by KFH: </span><a href="mailto:karshi.hasanov@utoronto.ca" style="color: rgb(145, 145, 145);">karshi.hasanov@utoronto.ca</a></div><div><span style="color: rgb(145, 145, 145);"># Date: Feb 18, 2009</span></div><div><span style="color: rgb(145, 145, 145);"># Last Modified: August 6, 2017</span></div><div><span style="color: rgb(145, 145, 145);"># Description: Installing the Apache Web Server</span></div><div><br /></div><div><span style="font-size: 36px; font-weight: bold;">Apache 2.4 Server on FreeBSD</span></div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;"> </span><span style="font-size: 24px; font-weight: bold;">Installation</span></div><div>=&gt; <span style="font-weight: bold;">cd </span><span style="color: rgb(148, 17, 0);">/usr/ports/www/apache24 </span></div><div>=&gt;  <span style="font-weight: bold;">sudo make install </span> </div><div>(leave the default options).</div><div><span style="color: rgb(121, 121, 121);">If this is not your first installation, you might need to clean the old one:</span></div><div><span style="color: rgb(121, 121, 121);">=&gt; sudo make clean &amp;&amp; sudo make rmconfig</span></div><div><br /></div><div>Add the line <span style="font-weight: bold;">apache24_enable</span>='<span style="font-weight: bold;">YES</span>' in your<span style="color: rgb(148, 17, 0);"> /etc/rc.conf</span> file</div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;">Configuring the main  </span><span style="font-size: 24px; color: rgb(148, 17, 0); font-weight: bold;">httpd.conf </span><span style="font-size: 24px; font-weight: bold;">File</span></div><div><br /></div><div>Open the <span style="color: rgb(148, 17, 0);">/usr/local/etc/apache24/httpd.conf</span> file and check the following settings:</div><div><br /></div><div><span style="font-weight: bold;">ServerAdmin </span><span style="color: rgb(0, 144, 81);">karshi.hasanov@utoronto.ca</span></div><div><span style="font-weight: bold;">DocumentRoot </span><span style="color: rgb(148, 17, 0);"> </span><span style="color: rgb(148, 17, 0); font-style: italic;">“</span><span style="color: rgb(148, 17, 0);"> </span><span style="color: rgb(148, 17, 0); font-style: italic;">/opt/hosting/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span><span style="color: rgb(148, 17, 0); font-style: italic;">”</span>  </div><div><span style="color: rgb(146, 146, 146);"># Default location of website </span></div><div><br /></div><div><span style="font-weight: bold; color: rgb(255, 64, 255);">&lt;Directory</span> "<span style="color: rgb(148, 17, 0);">/opt/hosting/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span> "<span style="font-weight: bold; color: rgb(255, 64, 255);">&gt;</span></div><div><span style="color: rgb(146, 146, 146);"># These are defaults. </span></div><div><span style="font-weight: bold;">   </span><span style="color: rgb(148, 17, 0); font-weight: bold;"> </span><span style="color: rgb(148, 17, 0); font-weight: bold;">Options</span> Indexes FollowSymLinks</div><div><span style="font-weight: bold;">    </span><span style="color: rgb(148, 17, 0); font-weight: bold;">AllowOverride</span> None</div><div><span style="font-weight: bold;">    </span><span style="color: rgb(148, 17, 0); font-weight: bold;">Require</span> all granted</div><div><span style="font-weight: bold; color: rgb(255, 64, 255);">&lt;/Directory&gt;</span></div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;">Initial</span><span style="font-size: 24px; font-weight: bold;"> Testing</span></div><div><span style="color: rgb(145, 145, 145);"># Create a test file under the </span><span style="color: rgb(145, 145, 145); font-weight: bold;">DocumentRoot </span><span style="color: rgb(145, 145, 145);">folder</span></div><div><span style="color: rgb(145, 145, 145);">#  ( /opt/hosting/www.karshi.ca/index.html)</span></div><div><br /></div><div><span style="color: rgb(145, 145, 145);"># Restart the server:</span></div><div>.=&gt; <span style="font-weight: bold;">sudo</span><span style="color: rgb(148, 17, 0);"> </span><span style="color: rgb(148, 17, 0); font-weight: bold;">/usr/local/etc/rc.d/</span><span style="color: rgb(148, 17, 0); font-weight: bold;">apache24</span><span style="color: rgb(0, 143, 0); font-weight: bold;"> </span><span style="color: rgb(0, 143, 0); font-style: italic; font-weight: bold;">onestart</span><span style="color: rgb(0, 143, 0); font-weight: bold;"> </span><span style="color: rgb(145, 145, 145); font-weight: bold;"> # </span><span style="color: rgb(145, 145, 145);"> Only if you are starting first time !</span></div><div><span style="color: rgb(145, 145, 145);"># Visit the website  http://www.karshi.ca  or http://IP_Address</span></div><div>  </div><div><span style="color: rgb(145, 145, 145);"># Watch for the log file</span></div><div>=&gt;<span style="font-weight: bold;"> tail </span>-f <span style="color: rgb(148, 17, 0);">/var/log/&lt;website&gt;</span><span style="color: rgb(148, 17, 0); font-weight: bold;">-access.log</span> </div><div>=&gt; tail -f <span style="color: rgb(148, 17, 0);">/var/log/&lt;website&gt;</span><span style="color: rgb(148, 17, 0); font-weight: bold;">-error.log</span></div><div><br /></div><div><span style="font-size: 24px; font-weight: bold;"> </span><span style="font-size: 24px; font-weight: bold;">Setting Up The Virtual Hosts</span></div><div><br /></div><div># Most of the time, we will need to host multiple web sites, so let us include (enable)</div><div># the Virtual Host File (its in the Supplemental Configuration Session):</div><div><span style="font-weight: bold;">Include</span> </div><div><span style="color: rgb(148, 82, 0);"> etc/apache24/extra/httpd-vhosts.conf</span></div><div># Note: If you use the Virtual Hosts, the Apache will ignore the DocumentRoot Directory.</div><div># Instead, it will default to the first (top) Virtual Host </div><div><br /></div><div> </div><div><span style="font-weight: bold;"><span style="font-weight: bold; color: rgb(148, 55, 255);">&lt;VirtualHost *:80</span>&gt;</span></div><div>    <span style="color: rgb(145, 145, 145);"># e-mail for the server admin</span></div><div>    <span style="font-weight: bold;">ServerAdmin</span> <span style="color: rgb(79, 143, 0);">karshi.hasanov@icloud.com</span></div><div>    <span style="color: rgb(145, 145, 145);"># Top directory where the files for this virtual hosts are</span></div><div>    <span style="font-weight: bold;">DocumentRoot</span> "<span style="color: rgb(148, 17, 0);">/opt/hosting/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span>"</div><div>    # The server URL for the public. Make sure it's in DNS (local and ISP )</div><div>    <span style="font-weight: bold;">ServerName</span><span style="color: rgb(4, 51, 255);"> www.karshi.ca</span></div><div>    <span style="color: rgb(145, 145, 145);"># All the errors with the config files, server misconfiguirations etc. are logged here</span></div><div>    <span style="font-weight: bold;">ErrorLog</span> "<span style="color: rgb(148, 17, 0);">/var/log/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span><span style="font-weight: bold;">-error.log</span>"</div><div>    <span style="color: rgb(145, 145, 145);"># This is the access log in common format. </span></div><div>    <span style="font-weight: bold;">CustomLog</span> "<span style="color: rgb(148, 17, 0);">/var/log/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span><span style="font-weight: bold;">-access.log</span>" common</div><div>   <span style="color: rgb(145, 145, 145);"> # Use this to give access to the servers.</span></div><div>    <span style="font-weight: bold; color: rgb(148, 17, 0);">&lt;Directory</span> "<span style="color: rgb(148, 17, 0);">/opt/hosting/</span><span style="color: rgb(4, 51, 255);">www.karshi.ca</span>"<span style="color: rgb(148, 17, 0);">&gt;</span></div><div>        <span style="font-weight: bold;">Options</span> All</div><div>        <span style="font-weight: bold;">AllowOverride</span> All</div><div>        # The syntax is case sensitive!</div><div>        <span style="font-weight: bold;">Require</span> all granted</div><div>     <span style="font-weight: bold; color: rgb(148, 17, 0);">&lt;/Directory&gt;</span></div><div><span style="font-weight: bold; color: rgb(148, 55, 255);">&lt;/VirtualHost&gt;</span></div><div><br /></div><div><span style="font-weight: bold; text-decoration: underline;"> </span></div><div><span style="font-weight: bold; font-size: 24px;">Setting Up HTTPS (SSL Support)</span></div><div><br /></div><div>Edit the  "<span style="font-style: italic; font-weight: bold;">/usr/local/etc/apache24/httpd.conf </span>" and enable the following modules:</div><div><br /></div><div><span style="font-weight: bold;">LoadModule </span><span style="color: rgb(0, 143, 0);">socache_shmcb_module</span><span style="color: rgb(148, 17, 0);"> libexec/apache24/</span><span style="font-weight: bold;">mod_socache_shmcb.so</span></div><div><span style="color: rgb(145, 145, 145);"># This module provides for creation and access to a cache backed by a high-performance </span></div><div><span style="color: rgb(145, 145, 145);"># cyclic buffer inside a shared memory segment.</span></div><div><br /></div><div><span style="font-weight: bold;">LoadModule<span style="font-weight: bold; color: rgb(0, 143, 0);"> </span></span><span style="color: rgb(0, 143, 0);">log_config_module</span><span style="color: rgb(148, 17, 0);"> libexec/apache24</span>/<span style="font-weight: bold;">mod_log_config.so</span></div><div><span style="font-weight: bold;"> </span><span style="color: rgb(146, 146, 146);"># Allows flexible logging of client requests in a customizable format.</span></div><div><br /></div><div><span style="font-weight: bold;">LoadModule </span>ssl_module libexec/apache24/<span style="font-weight: bold;">mod_ssl.so</span></div><div><span style="color: rgb(145, 145, 145);"># This module provides SSL v3 and TLS v1.x support for the Apache HTTP Server.</span></div><div> </div><div><span style="color: rgb(145, 145, 145);"># Uncomment the line:</span></div><div><span style="font-weight: bold;">Include</span> <span style="color: rgb(148, 17, 0);">etc/apache24/extra/</span><span style="font-weight: bold;">httpd-ssl.conf</span></div><div><br /></div><div>#——————————— hhtpd-ssl.conf ---------------------------</div><div>=&gt;<span style="font-weight: bold;"> sudo</span> vi  <span style="font-style: italic; color: rgb(148, 17, 0);">/usr/local/etc/apache24/extra/</span><span style="font-style: italic; font-weight: bold;">httpd-ssl.conf </span></div><div><br /></div><div><span style="font-weight: bold; color: rgb(148, 55, 255);">&lt;VirtualHost _default_:443&gt;</span></div><div><span style="font-weight: bold;">DocumentRoot </span>"<span style="color: rgb(148, 17, 0);">/opt/hosting/</span><span style="color: rgb(0, 150, 255);">www.</span><span style="color: rgb(0, 150, 255);">karshi.ca</span>”</div><div><span style="font-weight: bold;">ServerName  </span>www.karshi.ca:443</div><div><span style="font-weight: bold;">ServerAdmin </span>karshi.hasanov@gmail.com</div><div><span style="font-weight: bold;">ErrorLog  </span>"<span style="color: rgb(148, 17, 0);">/var/log/</span><span style="color: rgb(83, 27, 147);">ssl_www.karhsi.ca-error.log</span>"</div><div><span style="font-weight: bold;">TransferLog </span>"<span style="color: rgb(148, 17, 0);">/var/log/</span><span style="color: rgb(83, 27, 147);">ssl_www.karshi.ca-access.log</span>"</div><div><br /></div><div><span style="color: rgb(146, 146, 146);">#   Enable/Disable SSL for this virtual host.</span></div><div><span style="font-weight: bold;"> SSLEngine </span>on</div><div><br /></div><div><span style="font-weight: bold;">  SSLCertificateFile </span>"<span style="color: rgb(148, 17, 0);">/etc/kfh-certs/ca/certs/freebsd-srv/</span><span style="color: rgb(0, 145, 147);">freebsd.crt</span></div><div>  <span style="font-weight: bold;">SSLCertificateKeyFile </span>"<span style="color: rgb(148, 17, 0);">/etc/kfh-certs/ca/certs/freebsd-srv/</span>f<span style="color: rgb(0, 145, 147);">reebsd_key.pem</span>"</div><div><br /></div><div><span style="color: rgb(145, 145, 145);"># Don’t forget to modify this directory and create the “/opt/hosting/scripts” folder:</span></div><div><span style="color: rgb(145, 145, 145);"># sudo mkdir /opt/hosting/scripts &amp;&amp; sudo chown www:www /opt/hosting/scripts</span></div><div><span style="font-weight: bold;">    &lt;Directory </span>"<span style="color: rgb(148, 17, 0);">/opt/hosting/scripts/cgi-bin</span>” &gt;</div><div>            SSLOptions +StdEnvVars</div><div><span style="font-weight: bold;">    &lt;/Directory&gt;</span></div><div><br /></div><div><span style="font-weight: bold;">CustomLog </span>“ <span style="color: rgb(148, 17, 0);">/var/log/</span>ssl_www.karshi.ca<span style="font-weight: bold;">-request.log</span>”  \</div><div>                       "%t %h %{SSL_PROTOCOL}x %{SSL_CIPHER}x \"%r\" %b"</div><div><br /></div><div><span style="font-weight: bold; color: rgb(148, 55, 255);">&lt;/VirtualHost&gt;</span></div><div><br /></div><div># Finally, restart the server ( reload won’t load the modules !)</div><div>=&gt;<span style="font-weight: bold;"> sudo service apache24 restart</span></div><div><br /></div><div><b><font style="font-size: 24px;">Apache Reverse Proxy</font></b></div><div><br /></div><div># Make sure you that PROXY was set to “yes” during the Apache Server installation.</div><div># ( usually its default )</div><div><b><font style="font-size: 18px;">Modules needs to be Enabled:</font></b></div><div><font color="#009193">LoadModule</font> <font color="#0096ff">proxy_module libexec/apache24/</font><font color="#009193">mod_proxy.so</font></div><div><font color="#009193">LoadModule</font><font color="#0096ff"> proxy_http_module libexec/apache24</font>/<font color="#009193">mod_proxy_http.so</font></div><div><br /></div><div><b><font style="font-size: 18px;">Our Goal:</font></b></div><div><font color="#929292"># We have a host server (FreeBSD) running the Apache Server on 192.168.100.250 (eth0)</font></div><div><font color="#929292"># and the Ubuntu Server as VM inside our server. Its IP = 172.16.0.100 (eth1).</font></div><div><font color="#929292"># We want our Apacher Server on FreeBSD act like a proxy server to our internal website</font></div><div><font color="#929292"># ( which runs inside the Ubuntu server)</font></div><div><font color="#929292"># Any client looking for “osm.karshi.ca” needs to go to “http://172.16.0.100”</font></div><div><font color="#929292"># Our virtual host for “osm.karshi.ca” on FreeBSD (192.168.100.250):</font></div><div><font color="#9437ff">&lt;VirtualHost *:80&gt;</font></div><div>       <b> ServerAdmin</b> <font color="#009193">karshi.hasanov@utoronto.ca</font></div><div>        <b>ServerName</b> osm.karshi.ca</div><div>        <b>ServerAlias</b> map.karshi.ca</div><div><br /></div><div>        <b>ProxyPass</b><font color="#ff2f92"><b> /</b> </font><font color="#008f00">http://172.16.0.100/</font></div><div>        <b>ProxyPassReverse<font color="#ff2f92"> /</font></b><font color="#008f00"> http://172.16.0.100/</font></div><div><br /></div><div>        <font color="#ff2f92">ErrorLog</font> "<font color="#941100">/var/log/</font><font color="#ff2f92">osm.karshi.ca-error.log</font>"</div><div>       <font color="#ff2f92"> CustomLog</font> "<font color="#941100">/var/log/</font><font color="#ff2f92">osm.karshi.ca-access.log</font>" <b>common</b></div><div><font color="#9437ff">&lt;/VirtualHost&gt;</font></div><div><br /></div><div><font color="#929292">Note: We assume that our website on Ubuntu is running and listenning port 80.</font></div><div><font color="#929292">          If its not on the port 80 , you need to modify the destination link.</font></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div><div><br /></div></en-note>